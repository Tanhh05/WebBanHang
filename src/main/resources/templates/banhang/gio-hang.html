<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Gi·ªè H√†ng</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<h2 class="fw-bold text-primary">üõí Gi·ªè H√†ng C·ªßa B·∫°n</h2>

<table class="table table-bordered">
  <thead class="table-dark">
  <tr>
    <th>S·∫£n ph·∫©m</th>
    <th>SL</th>
    <th>Gi√°</th>
    <th>T·ªïng</th>
    <th>H√†nh ƒë·ªông</th>
  </tr>
  </thead>
  <tbody id="gioHangNoiDung">
  <!-- D·ªØ li·ªáu gi·ªè h√†ng s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
  </tbody>
</table>

<p class="fw-bold fs-5">T·ªïng ti·ªÅn: <span id="tongTien">0</span> VNƒê</p>

<a href="/ban-hang/hien-thi" class="btn btn-secondary">üîô Ti·∫øp t·ª•c mua h√†ng</a>
<button class="btn btn-danger" onclick="xoaGioHang()">üóë X√≥a gi·ªè h√†ng</button>
<!-- N√∫t thanh to√°n -->
<button class="btn btn-success" onclick="hienFormThanhToan()">üí≥ Thanh to√°n</button>

<!-- Form nh·∫≠p th√¥ng tin kh√°ch h√†ng -->
<div id="formThanhToan" style="display: none;">
  <h3 class="text-primary">Th√¥ng tin kh√°ch h√†ng</h3>
  <input type="text" id="tenKhachHang" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" class="form-control mb-2">
  <input type="text" id="sdtKhachHang" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" class="form-control mb-2">
  <button class="btn btn-primary" onclick="thanhToan()">‚úÖ X√°c nh·∫≠n thanh to√°n</button>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Hi·ªÉn th·ªã form thanh to√°n
  function hienFormThanhToan() {
    document.getElementById("formThanhToan").style.display = "block";
  }

  // G·ª≠i d·ªØ li·ªáu thanh to√°n
  function thanhToan() {
    let ten = document.getElementById("tenKhachHang").value;
    let sdt = document.getElementById("sdtKhachHang").value;

    if (ten === "" || sdt === "") {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng!");
      return;
    }

    fetch("/gio-hang/thanh-toan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ten, sdt })
    }).then(response => {
      if (response.ok) {
        alert("Thanh to√°n th√†nh c√¥ng!");
        xoaGioHang();  // X√≥a gi·ªè h√†ng sau khi thanh to√°n th√†nh c√¥ng
        window.location.reload();
      } else {
        alert("C√≥ l·ªói x·∫£y ra khi thanh to√°n!");
      }
    });
  }

  // üìå Load gi·ªè h√†ng khi trang t·∫£i
  function loadGioHang() {
    fetch("/gio-hang/xem")
            .then(response => response.json())
            .then(data => hienThiGioHang(data));
  }

  // üìå Hi·ªÉn th·ªã gi·ªè h√†ng
  function hienThiGioHang(data) {
    let gioHangNoiDung = document.getElementById("gioHangNoiDung");
    let tongTien = 0;
    gioHangNoiDung.innerHTML = "";

    data.forEach(sp => {
      let tongGia = sp.soLuong * sp.donGia;
      tongTien += tongGia;

      gioHangNoiDung.innerHTML += `
                <tr>
                    <td>${sp.tenSanPham}</td>
                    <td>
                        <input type="number" value="${sp.soLuong}" min="1" class="form-control"
                            onchange="capNhatSoLuong('${sp.tenSanPham}', this.value)">
                    </td>
                    <td>${sp.donGia.toLocaleString()} VNƒê</td>
                    <td>${tongGia.toLocaleString()} VNƒê</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="xoaSanPham('${sp.tenSanPham}')">‚ùå X√≥a</button>
                    </td>
                </tr>
            `;
    });

    document.getElementById("tongTien").innerText = tongTien.toLocaleString();
  }

  // üìå C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
  function capNhatSoLuong(tenSanPham, soLuong) {
    fetch("/gio-hang/cap-nhat", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ tenSanPham, soLuong })
    }).then(() => loadGioHang());
  }

  // üìå X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
  function xoaSanPham(tenSanPham) {
    fetch(`/gio-hang/xoa?tenSanPham=${encodeURIComponent(tenSanPham)}`, {
      method: "DELETE"
    }).then(() => loadGioHang());
  }

  // üìå X√≥a to√†n b·ªô gi·ªè h√†ng
  function xoaGioHang() {
    fetch("/gio-hang/xoa-tat-ca", {
      method: "DELETE"
    }).then(() => loadGioHang());
  }

  // G·ªçi h√†m load gi·ªè h√†ng khi trang t·∫£i
  loadGioHang();
</script>

</body>
</html>
