<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt S·∫£n Ph·∫©m</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .color-circle {
            width: 30px;
            height: 30px;
            display: inline-block;
            border-radius: 50%;
            border: 1px solid #ddd;
        }
        .size-btn {
            min-width: 50px;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="row">
        <!-- Th√¥ng tin s·∫£n ph·∫©m -->
        <div class="col-md-8">
            <h3 class="fw-bold">T√™n s·∫£n ph·∫©m - [[${spChiTiet.idSanPham.ten}]]</h3>
            <p class="text-muted">M√É SP: [[${spChiTiet.maSpct}]]</p>
            <h4 class="fw-bold text-danger">[[${#numbers.formatDecimal(spChiTiet.donGia, 0, 'COMMA', 0, 'POINT')}]] VNƒê</h4>

            <!-- M√†u s·∫Øc -->
            <div class="mt-3">
                <label class="fw-bold">M√†u s·∫Øc:</label>
                <span class="color-circle"
                      th:if="${spChiTiet.idMauSac != null and spChiTiet.idMauSac.ten != null}"
                      th:style="'background-color:' +
                                (${spChiTiet.idMauSac.ten.startsWith('#') ? spChiTiet.idMauSac.ten :
                                (spChiTiet.idMauSac.ten == 'ƒê·ªè m·∫≠n' ? '#800000' : '#000')})">
                </span>
                <span class="ms-2" th:text="${spChiTiet.idMauSac.ten != null ? spChiTiet.idMauSac.ten : 'Kh√¥ng c√≥ m√†u'}"></span>
            </div>

            <!-- K√≠ch th∆∞·ªõc -->
            <div class="mt-3">
                <label class="fw-bold">K√≠ch c·ª°:</label>
                <button class="btn btn-outline-dark m-1 size-btn">[[${spChiTiet.idKichThuoc.ten}]]</button>
            </div>

            <div class="mt-3">
                <label class="fw-bold">S·ªë l∆∞·ª£ng:</label>
                <button class="btn btn-outline-dark m-1 size-btn">[[${spChiTiet.soLuong}]]</button>
            </div>

            <!-- N√∫t th√™m v√†o gi·ªè h√†ng -->
            <div class="mt-4">
                <form id="themGioHangForm">
                    <input type="hidden" name="idSanPham" th:value="${spChiTiet.idSanPham.id}">
                    <input type="hidden" name="tenSanPham" th:value="${spChiTiet.idSanPham.ten}">
                    <input type="hidden" name="donGia" th:value="${spChiTiet.donGia}">
                    <input type="hidden" name="mauSac" th:value="${spChiTiet.idMauSac.ten}">
                    <input type="hidden" name="kichThuoc" th:value="${spChiTiet.idKichThuoc.ten}">
                    <input type="number" name="soLuong" value="1" min="1">
                    <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">TH√äM V√ÄO GI·ªé H√ÄNG</button>
                </form>
            </div>
        </div>

        <!-- Gi·ªè h√†ng -->
        <div class="col-md-4">
            <h4 class="fw-bold">üõí Gi·ªè h√†ng</h4>
            <table class="table">
                <thead>
                <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>SL</th>
                    <th>Gi√°</th>
                    <th>T·ªïng</th>
                </tr>
                </thead>
                <tbody id="gioHangNoiDung">
                <!-- D·ªØ li·ªáu gi·ªè h√†ng s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </tbody>
            </table>
            <p class="fw-bold">T·ªïng ti·ªÅn: <span id="tongTien">0</span> VNƒê</p>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("themGioHangForm");
        const gioHangNoiDung = document.getElementById("gioHangNoiDung");
        const tongTienElement = document.getElementById("tongTien");

        // üõí X·ª≠ l√Ω khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
        form.addEventListener("submit", async function (event) {
            event.preventDefault();

            let formData = new FormData(form);

            try {
                let response = await fetch("/gio-hang/them", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams(formData)
                });

                let data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || "C√≥ l·ªói x·∫£y ra khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!");
                }

                hienThiGioHang(data);
            } catch (error) {
                alert(error.message);
            }
        });

        // üõí Hi·ªÉn th·ªã gi·ªè h√†ng
        function hienThiGioHang(data) {
            gioHangNoiDung.innerHTML = "";
            let tongTien = 0;

            if (!Array.isArray(data) || data.length === 0) {
                gioHangNoiDung.innerHTML = "<tr><td colspan='4' class='text-center'>Gi·ªè h√†ng tr·ªëng!</td></tr>";
                tongTienElement.innerText = "0 VNƒê";
                return;
            }

            data.forEach(sp => {
                let tongGia = sp.soLuong * sp.donGia;
                tongTien += tongGia;

                gioHangNoiDung.innerHTML += `
                <tr>
                    <td>${sp.tenSanPham}</td>
                    <td>${sp.soLuong}</td>
                    <td>${sp.donGia.toLocaleString()} VNƒê</td>
                    <td>${tongGia.toLocaleString()} VNƒê</td>
                </tr>
            `;
            });

            tongTienElement.innerText = tongTien.toLocaleString() + " VNƒê";
        }

        // üîÑ T·∫£i gi·ªè h√†ng khi trang load
        async function loadGioHang() {
            try {
                let response = await fetch("/gio-hang/xem");
                let data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error("D·ªØ li·ªáu gi·ªè h√†ng kh√¥ng h·ª£p l·ªá!");
                }

                hienThiGioHang(data);
            } catch (error) {
                console.error("L·ªói khi t·∫£i gi·ªè h√†ng:", error);
            }
        }

        // G·ªçi load gi·ªè h√†ng ngay khi trang load
        loadGioHang();
    });
</script>
</body>
</html>
